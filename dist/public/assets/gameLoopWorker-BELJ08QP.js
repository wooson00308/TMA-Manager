(function(){"use strict";function E(t,a){const i={...t};return a.effects.forEach(e=>{const s=i[e.stat]||0,m=e.modifier/100;i[e.stat]=Math.round(s*(1+m))}),i}function N(t,a,i){const e=t.find(s=>s.id===a);return e?{id:e.id,name:e.name,callsign:e.callsign,team:(i==null?void 0:i.team)==="team2"?"enemy":"ally",initial:e.name.charAt(0).toUpperCase()}:(console.warn(`Pilot ${a} not found in pilots data`),{id:a,name:`Unknown Pilot ${a}`,callsign:`PILOT-${a}`,team:(i==null?void 0:i.team)==="team2"?"enemy":"ally",initial:"U"})}function C(t,a,i,e,s){var l;const m=((l=a.teamFormations)==null?void 0:l[t.team])||{name:"balanced",effects:[]},n=E(t,m),d=a.participants.filter(r=>(e.team==="ally"?r.team==="team2":r.team==="team1")&&r.status!=="destroyed");a.participants.filter(r=>(e.team==="ally"?r.team==="team1":r.team==="team2")&&r.status!=="destroyed"&&r.pilotId!==t.pilotId);const o={firepower:n.firepower||75,speed:n.speed||70,armor:n.armor||70},c=Math.random(),g=n.hp<(n.maxHp||100)*.3,x=a.turn<3;if(console.log(`${e.name} using ${m.name} formation - Stats: F:${o.firepower} S:${o.speed} A:${o.armor}`),d.length>0&&c<.8){const r=d.reduce((y,p)=>{const I=Math.abs(n.position.x-p.position.x)+Math.abs(n.position.y-p.position.y),U=Math.abs(n.position.x-y.position.x)+Math.abs(n.position.y-y.position.y);return I<U?p:y}),M=Math.abs(r.position.x-n.position.x)+Math.abs(r.position.y-n.position.y),A=Math.max(n.range||100,8);if(M<=A){const y=a.participants.findIndex(p=>p.pilotId===r.pilotId);return{type:"ATTACK",pilotName:e.name,targetIndex:y,dialogue:h(e,"combat",m.name)}}const T=b(n.position,r.position,e.team,o);return{type:"MOVE",pilotName:e.name,newPosition:T,dialogue:h(e,"movement",m.name)}}if(x&&c<.3)return{type:"COMMUNICATE",pilotName:e.name,dialogue:h(e,"combat",m.name)};if(g&&c<.4)return{type:"COMMUNICATE",pilotName:e.name,dialogue:h(e,"damage",m.name)};if(c<.9){const r=P(n.position,e.team,d,o);return{type:"MOVE",pilotName:e.name,newPosition:r,dialogue:h(e,"movement",m.name)}}return{type:"COMMUNICATE",pilotName:e.name,dialogue:"대기 중..."}}function h(t,a,i){var d;const e={aggressive:{combat:["전력 공격!","집중 포화!","돌파한다!"],movement:["전진!","포지션 공격!","압박한다!"],damage:["더 세게!","반격 개시!","물러나지 않는다!"]},defensive:{combat:["방어선 유지!","엄호 사격!","수비 위치!"],movement:["방어선 재배치!","안전 지대로!","수비 강화!"],damage:["방어 체제!","엄폐 필요!","지원 요청!"]},mobile:{combat:["기동 타격!","히트 앤 런!","측면 공격!"],movement:["빠르게 이동!","우회 기동!","위치 변경!"],damage:["회피 기동!","탈출 루트!","재정비!"]},balanced:{combat:["공격 개시!","타겟 확인!","사격!"],movement:["이동 중!","포지션 변경!","재배치!"],damage:["데미지 확인!","시스템 체크!","전투 지속!"]}},s=i||"balanced",m=a,n=((d=e[s])==null?void 0:d[m])||e.balanced[m]||["..."];return n[Math.floor(Math.random()*n.length)]}function b(t,a,i,e){const s=Math.max(1,Math.floor(e.speed/30)),m=a.x>t.x?s:a.x<t.x?-s:0,n=a.y>t.y?s:a.y<t.y?-s:0;return{x:Math.max(2,Math.min(17,t.x+m)),y:Math.max(1,Math.min(12,t.y+n))}}function P(t,a,i,e){const s=Math.max(1,Math.floor(e.speed/30)),m=a==="ally"?1:-1;return{x:Math.max(2,Math.min(17,t.x+m*s)),y:Math.max(1,Math.min(12,t.y+(Math.random()>.5?1:-1)))}}function D(t){const a=t.filter(e=>e.team==="team1"&&e.status!=="destroyed").length,i=t.filter(e=>e.team==="team2"&&e.status!=="destroyed").length;return a===0?"defeat":i===0?"victory":null}function $(t,a,i){const e=t.participants.map(o=>({...o})),s=[...t.log];t.participants.filter(o=>o.status!=="destroyed").map(o=>{const c=N(a,o.pilotId,o);return{...C(o,t,a,c),pilotId:o.pilotId}}).forEach(o=>{var g,x;const c=e.find(l=>l.pilotId===o.pilotId);if(c)switch(o.type){case"MOVE":o.newPosition&&(c.position=o.newPosition,s.push({timestamp:Date.now(),type:"movement",message:o.dialogue||"...",speaker:o.pilotName}));break;case"ATTACK":if(o.targetIndex!==void 0){const l=e[o.targetIndex];if(l&&l.status!=="destroyed"){const r=((g=c.pilotStats)==null?void 0:g.accuracy)||70,M=c.firepower||75,A=l.armor||70,T=((x=l.pilotStats)==null?void 0:x.reaction)||70,y=Math.max(.1,Math.min(.95,(r-T+50)/100));if(Math.random()<y){const p=Math.max(5,M-A+Math.random()*20);l.hp=Math.max(0,l.hp-Math.floor(p)),l.hp===0?l.status="destroyed":l.hp<(l.maxHp||100)*.3&&(l.status="damaged"),s.push({timestamp:Date.now(),type:"attack",message:`${o.dialogue} (${Math.floor(p)} 데미지!)`,speaker:o.pilotName})}else s.push({timestamp:Date.now(),type:"attack",message:`${o.dialogue} (빗나감!)`,speaker:o.pilotName})}}break;case"COMMUNICATE":s.push({timestamp:Date.now(),type:"communication",message:o.dialogue||"...",speaker:o.pilotName});break}});const n={...t,participants:e,log:s},d=D(n.participants);return d&&(n.phase="completed",n.log.push({timestamp:Date.now(),type:"system",message:d==="victory"?"승리!":"패배..."})),n.turn=t.turn+1,n}let u=null,k=[],f=null,w=1e3;function O(){f!==null||!u||(f=setInterval(()=>{if(!u)return;u=$(u,k);const t={type:"STATE_UPDATE",state:u};self.postMessage(t),u.phase==="completed"&&v()},w))}function v(){f!==null&&(clearInterval(f),f=null)}self.onmessage=t=>{const{type:a}=t.data;switch(a){case"INIT":u=t.data.payload.state,k=t.data.payload.pilots,t.data.payload.terrainFeatures,w=t.data.payload.tickMs??w;break;case"START":O();break;case"STOP":v();break}}})();
